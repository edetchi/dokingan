<?php
/*----------------------------------------------------------------------------------------------------------------------------------------------------------
    環境設定とライブラリを読み込み
----------------------------------------------------------------------------------------------------------------------------------------------------------*/
require_once("common.php");
// セッションの開始
session_start();
/*########################################################################################
    ログイン状態のチェック開始
########################################################################################*/
//ログインフラグ$logined_flagを初期化(非ログイン状態に)
$logined_flag = false;
/*=============================================================================
    ログインページ(login.php)以外の時
=============================================================================*/
if (!isset($ignore_login)) {
/*----------------------------------------------------------------------------------------------------------------------------------------------------------
    ログイン状態時の処理、$_SESSION["user_id"]にはログイン成功時にデーターベースの一意なuser_idが入っている
----------------------------------------------------------------------------------------------------------------------------------------------------------*/
    if (isset($_SESSION["user_id"])) {
        $session_user_id = $_SESSION["user_id"];
        try {
            $stmt = $pdo->prepare("SELECT * FROM users WHERE user_id = ? LIMIT 1");
            $stmt->execute(array($session_user_id)); // クエリの実行
            $row_user = $stmt->fetch(PDO::FETCH_ASSOC); // SELECT結果を配列に格納
            if ($row_user) {
                // 該当のuserレコードがあったらログイン状態にする
                $logined_flag = true;
            }
        } catch (PDOException $e) {
            // エラー発生時
            exit("ログイン状態のチェックに失敗しました");
        }
    }
/*----------------------------------------------------------------------------
    非ログイン状態時の処理
----------------------------------------------------------------------------*/
    if (!$logined_flag) {
        //ログインページへジャンプ
        header("location: login.php");
        exit;
    }
}
/*########################################################################################
    ログイン状態のチェック終了
########################################################################################*/
?>